---
title: "Car Prices for Dummys"
author: "Dustin Leatherman, Kyra Kemp, Danielle Deng, Zhichun Ke"
date: "11/16/2019"
output:
  slidy_presentation: default
  html_document: default
  ioslides_presentation: default
  pdf_document: default
  beamer_presentation: default
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, messsage = FALSE, fig.width = 10)
library(tidyverse)
library(ggplot2)
library(knitr)
library(kableExtra)
library(broom)
library(GGally)
library(grid)
library(gridExtra)
library(ggfortify)

cars <- readxl::read_excel("~/Downloads/kuiper.xls")
cars.clean <- 
  cars %>% 
  # remove trim and model because they are discrete with high cardinality and are more descriptive
  select(-Trim, -Model) %>% 
  # set low cardinality numerics as factors to treat them as such
  mutate(
    cylinder.factor = factor(Cylinder),
    cruise.factor = factor(Cruise), 
    sound.factor = factor(Sound), 
    leather.factor = factor(Leather), 
    doors.factor = factor(Doors),
    log.price = log(Price)
  )
```

# Introduction

@Kyra to fill this in

# The Data
> This dataset is a representative sample of over eight hundred 2005 GM cars from the Kelly Blue Book.

Due to the right-skewed nature of Price, a log transformation has been applied and displayed alongside for comparison.

@Zhichun @Danielle to fill this in

```{r fig.height=8, warning=FALSE, message=FALSE}
cars.clean %>% 
  ggpairs(
    columns = c("Price", "log.price", "Mileage", "Liter", "cylinder.factor", "doors.factor", "cruise.factor", "sound.factor", "leather.factor"),
    columnLabels = c("Price", "Log(Price)", "Mileage", "Liter", "Cylinder", "Doors", "Cruise", "Sound", "Leather"),
    title = c("Generic Scatterplot")
  ) + labs(caption = "Figure 1. A general sense of the relationship between variables is provided.")
```

# Summary (cont.) 

```{r fig.height=8, warning=FALSE, message=FALSE}
cars.clean %>% 
  ggpairs(
    columns = c("Price", "log.price", "Mileage", "Liter", "cylinder.factor", "doors.factor", "cruise.factor", "sound.factor", "leather.factor"),
    columnLabels = c("Price", "Log(Price)", "Mileage", "Liter", "Cylinder", "Doors", "Cruise", "Sound", "Leather"),
    aes(color = Type, alpha = 0.3), 
    legend = c(1,1),
    # correlation text is off so this makes it readable
    upper = list(continuous = wrap("cor", size = 2.5, hjust=0.15, alignPercent=1)),
    title = c("Scatterplot by Type"),
  ) + labs(caption = "Figure 2. Relationships between variables are explored in regards to Type.")
```

# Summary (cont.) 

```{r fig.height=8, warning=FALSE, message=FALSE}
cars.clean %>% 
  ggpairs(
    columns = c("Price", "log.price", "Mileage", "Liter", "cylinder.factor", "doors.factor", "cruise.factor", "sound.factor", "leather.factor"),
    columnLabels = c("Price", "Log(Price)", "Mileage", "Liter", "Cylinder", "Doors", "Cruise", "Sound", "Leather"),
    aes(color = Make, alpha = 0.3), 
    legend = c(1,1),
    # correlation text is off so this makes it readable
    upper = list(continuous = wrap("cor", size = 2, hjust=0.15, alignPercent=1)),
    title = c("Scatterplot by Make")
  ) + labs(caption = "Figure 3. Relationships between variables are explored in regards to Make.")
```

# Analysis

```{r}
cars.m.full <- 
  cars.clean %>% 
  lm(log.price ~ Mileage + Make + Type + Liter + cylinder.factor + doors.factor + cruise.factor + sound.factor + leather.factor, data = .)

cars.m.adjusted1 <- 
  cars.clean %>% 
  lm(log.price ~ Mileage + Make + Type + Liter + cylinder.factor + cruise.factor + sound.factor + leather.factor, data = .)

cars.m.adjusted2 <- 
  cars.clean %>% 
  lm(log.price ~ Mileage + Make + Type + Liter + cruise.factor + sound.factor + leather.factor, data = .)
```

Prior to fitting any model, a full model will be fit first in order to ensure that model assumptions are correct. 

```{r fig.height=8, warning=FALSE, message=FALSE}
autoplot(cars.m.full)
```

### Normality

The residuals are close to the line barring a few outliers on the left tail. From a visual perspective, data appear normal but a Shapiro-Wilk test indicates there is convincing evidence that the data is non-normal (p-value = 0.002606). There are three outliers identified on the left tail that may be influencing this outcome. This must be explored. 

```{r warning=FALSE, message=FALSE}
shapiro.test(cars.m.full$residuals) %>% tidy %>% kable
```

### Linearity

There do not appear to be any patterns in the residuals indicating that a linear regression model is appropriate for the data.

### Constant Variance

The spread around y = 0 on the Residuals vs Fitted plot appears to be constant barring the same potential outliers present in the normal probability plot; however, the Brown-Forsyth test indicates that there is convincing evidence that the variance is not constant (p-value = 0.00016).

```{r warning=FALSE, message=FALSE}
lawstat::levene.test(
  cars.m.full$residuals, 
  group = cars.m.full$residuals <= median(cars.m.full$residuals)
) %>% 
  tidy %>% 
  kable

cor(cars$Cylinder, cars$Liter) %>% 
  kable(
    col.names = c("correlation"),
    caption = "Correlation between Liter and Cylinder"
  )

# checks to see aliases within a model. AKA says what a beta is dependent on if it was not estimated.
alias(cars.m.full)
```

There is multicollinearity present due to the high correlation between Liter and Cylinder. (see *Figure 1*). This further confirmed given a correlation coefficient of 0.958. Additionally, the **Doors** predictor is linearly dependent on the Indicator variables TypeWagon, TypeHatchback, and TypeSedan. This means that this coefficient cannot be estimated and thus should be removed from the model.

```{r}
car::vif(cars.m.adjusted1) %>% 
  tidy %>% 
  bind_rows(
    car::vif(cars.m.adjusted2) %>% tidy    
  ) %>% kable
```

Checking for Variance Inflation Factors for the model full model sans **Doors** yields extreme multicollinearity for cylinder and Liter. Given that Liter is more precise than Cylinder in terms of measurement and Cylinder has a higher correlation with log.price, Liter will be dropped from the model. This produces a drastic decrease in mulitcollinearity to a more acceptable level.

```{r}
cars.m.adjusted2$residuals %>%
  shapiro.test %>%
  tidy %>%
  bind_rows(
    lawstat::levene.test(
      cars.m.adjusted2$residuals, 
      group = cars.m.adjusted2$residuals <= median(cars.m.adjusted2$residuals)
    ) %>% tidy
  ) %>% select(method, statistic, p.value) %>% kable

augment(cars.m.adjusted2) %>% 
  mutate(
    stud.res = rstudent(cars.m.adjusted2), 
    is.outlier = stud.res > qt(1 - 0.05 / (2 * nrow(.)), nrow(.) - length(.) - 1)
  ) %>% 
  filter(is.outlier)
```

The data appears more normal now (Shapiro-Wilk Test. p-value = 0.1305) but there is still moderate evidence of non-constant variance (Brown-Forsythe. p-value = 0.0323). 

```{r yar}
lindia::gg_boxcox(cars.m.adjusted2)

cars.m.adjusted3 <- 
  cars.clean %>% 
  lm(log.price^1.6 ~ Mileage + Make + Type + Liter + cruise.factor + sound.factor + leather.factor, data = .)

cars.m.adjusted3$residuals %>%
  shapiro.test %>%
  tidy %>%
  bind_rows(
    lawstat::levene.test(
      cars.m.adjusted3$residuals, 
      group = cars.m.adjusted3$residuals <= median(cars.m.adjusted3$residuals)
    ) %>% tidy    
  ) %>% select(method, statistic, p.value) %>% kable
```

A Box-Cox transformation can be applied in order to help our constant variance issue. As noted, there is minimal improvement but enough to satisfy the assumption.

```{r}
autoplot(cars.m.adjusted3)
```


## Question 1
> How does Type, Cylinder, and Liter affect average Price? How does this change when Mileage is taken into account?



# Appendices

| Variable | Description|
|----------+---------------------------|
| Price    | suggested retail price of the used 2005 GM car in excellent condition. The condition of a car can greatly affect price. All cars in this data set were less than one year old when priced and considered to be in excellent condition. |
| Mileage  | number of miles that the car has been driven.|
| Make     | manufacturer of the car such as Saturn, Pontiac, and Chevrolet.|
| Model    | Specific models for each car manufacturer such as Ion, Vibe, Cavalier.|
| Trim     | Specific type of car model suc has SE Sedan 4D, Quad Coupe 2D.|
| Type     | Body type such as sedan, coupe, etc.|
| Cylinder | Number of cylinders in the engine.|
| Liter    | A more specific meaasure of engine size.|
| Doors    | Number of doors|
| Cruise   | Indicator representing whether the car has cruise control (1 = cruise).|
| Sound    | Indicator representing whether the car has upgraded speakers (1 = sound).|
| Leather  | Indicator representing whether the car has leather seats (1 = leather).|


