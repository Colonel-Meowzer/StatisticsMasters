---
title: "FinalProject"
author: "Dustin Leatherman"
date: "2/29/2020"
output: html_document
bibliography: FinalProject.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10)
library(tidyverse)
library(ggplot2)
library(zoo)
library(knitr)
library(astsa)
library(kableExtra)
library(grid)
library(gridExtra)
library(tibbletime)
library(ggfortify)

temps <- read.csv("~/projects/StatisticsMasters/TimeSeries/chicago_weather.csv")
```

# Climate in Chicago

Climate is defined as the long-term average of weather, typically over a period of 30 years [@IPCC]. Anthropogenic Climate Change is a well-known phenomenon that has captivated regional and national politics. This begs the obvious question, how has Chicago's local climate changed over the past 30 years? Observations over a 30 year period from O'Hare International Airport have been collected and freely distributed by the NOAA. O'Hare's position makes it ideal for weather data since it is far enough away from Lake Michigan to be free from the Lake Effect. 

The questions at hand are:
- Have Chicago Winters gotten warmer over the last 30 years?
- Have Chicago Summers gotten warmer over the last 30 years?
- What will the next 10 years look like for Chicago based on the past 30?

# Dataset

> Local Climatological Data (LCD) are summaries of climatological conditions from airport and other prominent weather stations managed by NWS, FAA, and DOD. The product includes hourly observations and associated remarks, and a record of hourly precipitation for the entire month. Also included are Weekly summaries summarizing temperature extremes, degree days, precipitation amounts and winds [@NOAA].

While there are many variables of interest in this dataset, the one most relevant to the questions at hand is Average Dry Bulb Temperature. The Dry Bulb Temperature is the temperature of air measured by a thermometer freely exposed to the air, but shielded from radiation and moisture. This is considered one of the most important climate variables for human comfort [@DryBulb]. This is in direct comparison to the Wet Bulb Temperature which is measured on a thermometer wrapped in a damp cloth to mimic the temperature at 100% humidity. While Chicago can experience extreme bouts of humidity, that measure will not be taken into consideration.

```{r fig.height=6}
temps.date <- temps %>% as_tibble %>% mutate_at("dateYYYYMMDD", as.Date) %>% as_tbl_time(index = dateYYYYMMDD)
temps.zoo.avg <- zoo(temps.date$WeeklyAverageDryBulbTemperature, order.by = temps.date$dateYYYYMMDD)
temps.zoo.max <- zoo(temps.date$WeeklyMaximumDryBulbTemperature, order.by = temps.date$dateYYYYMMDD)
temps.zoo.min <- zoo(temps.date$WeeklyMinimumDryBulbTemperature, order.by = temps.date$dateYYYYMMDD)

plot.data.avg <- 
  autoplot(temps.zoo.avg) + 
    ylab("Temperature (F)") + 
    xlab("Year") + 
    ggtitle("Average Weekly Temperature at O'Hare Intl Airport")

plot.data.max <-
  autoplot(temps.zoo.max) + 
    ylab("Temperature (F)") + 
    xlab("Year") + 
    ggtitle("High Weekly Temperature at O'Hare Intl Airport")

plot.data.min <-
  autoplot(temps.zoo.min) + 
    ylab("Temperature (F)") + 
    xlab("Year") + 
    ggtitle("Low Weekly Temperature at O'Hare Intl Airport")

grid.arrange(
  plot.data.avg,
  plot.data.max,
  plot.data.min,
  ncol = 1
)
```

The peaks represent the summers and the valleys represent the winters. There doesn't appear to be a trend with the trend year over year but there does appear to be more outliers with regards to extreme cold temperatures compared to extreme warm temperatures. Comparing the timeseries with Minimum and Maximum Dry Bulb Temperature show similar patterns. This graph highlights that Dry Bulb Temperature data is missing data for November and December of 2000.


```{r}
plot.acf.1 <- 
  autoplot(acf(coredata(temps.zoo.avg), na.action = na.pass, lag.max = 260, plot = FALSE)) +
  ggtitle("ACF Over 5 Years")

plot.pacf.1 <- 
  autoplot(pacf(coredata(temps.zoo.avg), na.action = na.pass, lag.max = 260, plot = FALSE)) +
  ggtitle("PACF Over 5 Years")

grid.arrange(plot.acf.1, plot.pacf.1, ncol = 2)
```

As expected, there is obvious seasonal correlation with the previous year.

```{r}
temps.zoo.avg.diff <- zoo(diff(temps.date$WeeklyAverageDryBulbTemperature, lag = 52), order.by = temps.date$dateYYYYMMDD)
autoplot(temps.zoo.avg.diff)

plot.acf.2 <- 
  autoplot(acf(coredata(temps.zoo.avg.diff), na.action = na.pass, lag.max = 104, plot = FALSE))

plot.pacf.2 <-
  autoplot(pacf(coredata(temps.zoo.avg.diff), na.action = na.pass, lag.max = 104, plot = FALSE))

grid.arrange(plot.acf.2, plot.pacf.2, ncol = 2)
```

When differenced over one year, much of the seasonality is reduced. Since there doesnt appear to be a quadratic trend, a second difference is not needed. This indicates that a Seasonal Differencing of 1 is a potential parameter. The ACF plot trails off to zero after the third lag indicating that an MA(3) model may be a possibility. The first lag is not significant but these models can still be run as options.

```{r}
temps.zoo.avg.diff <- zoo(diff(temps.date$WeeklyAverageDryBulbTemperature, lag = 52, differences = 1), order.by = temps.date$dateYYYYMMDD)
autoplot(temps.zoo.avg.diff)

  autoplot(acf(coredata(temps.zoo.avg.diff), na.action = na.pass, lag.max = 520, plot = FALSE))

  autoplot(pacf(coredata(temps.zoo.avg.diff), na.action = na.pass, lag.max = 520, plot = FALSE))

```

There doesn't appear to be any seasonality issues in the PACF plot. Some possible orders include AR(1) - AR(5). 


```{r}
temps.zoo.avg.diff <- zoo(diff(diff(temps.date$WeeklyAverageDryBulbTemperature, lag = 52)), order.by = temps.date$dateYYYYMMDD)
autoplot(temps.zoo.avg.diff)

plot.acf.2 <- 
  autoplot(acf(coredata(temps.zoo.avg.diff), na.action = na.pass, lag.max = 104, plot = FALSE))

plot.pacf.2 <-
  autoplot(pacf(coredata(temps.zoo.avg.diff), na.action = na.pass, lag.max = 104, plot = FALSE))

grid.arrange(plot.acf.2, plot.pacf.2, ncol = 2)
```

# Analysis

Potential Models include:
- ARIMA(1-5,1,1-3)[0,1,1]

```{r}
#sarima(coredata(temps.zoo.avg), p = 1, d = 0, q = 3, P = 0, D = 1, Q = 1, S = 52)
#sarima(coredata(temps.zoo.avg), p = 1, d = 0, q = 2, P = 0, D = 1, Q = 2, S = 52)
#sarima(coredata(temps.zoo.avg), p = 1, d = 0, q = 3, P = 0, D = 1, Q = 1, S = 52)
#sarima(coredata(temps.zoo.avg), p = 4, d = 0, q = 2, P = 0, D = 1, Q = 1, S = 52) Not significant
# sarima(coredata(temps.zoo.avg), p = 2, d = 0, q = 2, P = 0, D = 1, Q = 1, S = 52) Not Significant
# sarima(coredata(temps.zoo.avg), p = 3, d = 0, q = 2, P = 0, D = 1, Q = 1, S = 52) Not Significant
# sarima(coredata(temps.zoo.avg), p = 2, d = 0, q = 3, P = 0, D = 1, Q = 1, S = 52) Not significant
# sarima(coredata(temps.zoo.avg), p = 2, d = 0, q = 1, P = 0, D = 1, Q = 1, S = 52) Most significant. Ljung-Box still garbage
# sarima(coredata(temps.zoo.avg), p = 2, d = 0, q = 1, P = 1, D = 1, Q = 1, S = 52) SAR term not significant
# sarima(coredata(temps.zoo.avg), p = 2, d = 0, q = 2, P = 0, D = 2, Q = 1, S = 52) Second differencing better
# sarima(coredata(temps.zoo.avg), p = 0, d = 0, q = 0, P = 3, D = 1, Q = 1, S = 52)  Residuals not eas good.
# sarima(coredata(temps.zoo.avg), p = 0, d = 0, q = 0, P = 3, D = 2, Q = 1, S = 52)
# sarima(a[!is.na(a)], p = 0, d = 0, q = 0, P = 3, D = 2, Q = 1, S = 52)
# sarima(a[!is.na(a)], p = 0, d = 1, q = 2, P = 3, D = 2, Q = 1, S = 52) This one is pretty good for ACF plot. Ljung still needs work
# sarima(a[!is.na(a)], p = 0, d = 1, q = 3, P = 3, D = 2, Q = 1, S = 52) Same results. MA(3) param is not significant
# sarima(a[!is.na(a)], p = 0, d = 1, q = 2, P = 3, D = 2, Q = 2, S = 52)  Some seasonality issues addressed. SMA(2) makes SAR(1-3) irrelevant
# sarima(a[!is.na(a)], p = 0, d = 1, q = 2, P = 0, D = 2, Q = 3, S = 52) Most seasonality issues addressed. This seasonal model looks better. SMA(3) still insignificant
# sarima(a[!is.na(a)], p = 1, d = 1, q = 2, P = 0, D = 2, Q = 2, S = 52) NaNs produced in SMA. No bueno
# sarima(a[!is.na(a)], p = 0, d = 1, q = 2, P = 0, D = 2, Q = 2, S = 52) This model is probably the best ive found so far. Ljung box is still not good but it has a couple areas where its above the line which is a marked improvement.

# Maybe the data should be squared.
# sarima(coredata(temps.zoo.avg.sq), p = 0, d = 1, q = 0, P = 0, D = 1, Q = 2, S = 52) Seasonal patterns taken care of. Now to deal with non-seasonal patterns
# sarima(coredata(temps.zoo.avg.sq), p = 1, d = 1, q = 1, P = 0, D = 2, Q = 2, S = 52) This model fits the bill! All assumptions met all parameters significant. 14.74484 AICc


# sarima(temps$WeeklyAverageDryBulbTemperature, p = 3, d = 1, q = 1, P = 0, D = 2, Q = 2, S = 52) All assumptions met. There are a couple outliers but the number of transformations that can be applied with negative data are limited and while a few were attempted, there was no discernible benefit other than removing the ability to predict negative values. This is the final model that will be used. It is close enough and it works on the actual data.

sarima(temps$WeeklyAverageDryBulbTemperature, p = 3, d = 1, q = 1, P = 0, D = 2, Q = 2, S = 52)
```


